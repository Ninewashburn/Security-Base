<!-- src/app/pages/modals/export-modal/export-modal.html -->

<!-- Modal d'export XLSX/PDF avec filtres temporels -->
@if (isVisible) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    (click)="closeModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" (click)="$event.stopPropagation()">

      <!-- Header du modal -->
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">
            {{ exportOptions.type === 'xlsx' ? 'ðŸ“Š Export Excel' : 'ðŸ“„ Export PDF' }}
          </h3>
          <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Corps du modal -->
      <div class="px-6 py-4 space-y-4">

        <!-- Informations actuelles -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-blue-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h4 class="text-sm font-medium text-blue-800">Ã‰tat actuel</h4>
              <p class="text-sm text-blue-700 mt-1">
                {{ totalIncidents }} incident(s) total dans la base
                @if (hasActiveFilters) {
                  <span class="block">
                    {{ filteredIncidents.length }} incident(s) aprÃ¨s filtrage
                  </span>
                }
              </p>
            </div>
          </div>
        </div>

        <!-- SÃ©lection de la pÃ©riode -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">PÃ©riode d'export</label>

          <!-- Options rapides -->
          <div class="space-y-2">
            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="all" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>Tous les incidents</strong>
                <span class="text-gray-500 block">{{ totalIncidents }} incident(s) depuis le dÃ©but</span>
              </span>
            </label>

            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="current" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>Incidents actuellement affichÃ©s</strong>
                <span class="text-gray-500 block">
                  {{ paginatedIncidents.length }} incident(s) sur cette page
                </span>
              </span>
            </label>

            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="year" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>AnnÃ©e en cours ({{ exportOptions.selectedYear }})</strong>
                <span class="text-gray-500 block">{{ getIncidentsByYear(currentYear).length }} incident(s)</span>
              </span>
            </label>

            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="custom-year" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>AnnÃ©e spÃ©cifique</strong>
              </span>
            </label>

            <!-- SÃ©lecteur d'annÃ©e personnalisÃ©e -->
            @if (exportOptions.period === 'custom-year') {
              <div class="ml-7 mt-2">
                <select [(ngModel)]="exportOptions.selectedYear" (ngModelChange)="onYearChange($event)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                  @for (year of availableYears; track year) {
                    <option [value]="year">
                      {{ year }} ({{ getIncidentsByYear(year).length }} incident(s))
                    </option>
                  }
                </select>
              </div>
            }

            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="months" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>Derniers mois</strong>
              </span>
            </label>

            <!-- SÃ©lecteur de mois -->
            @if (exportOptions.period === 'months') {
              <div class="ml-7 mt-2 space-y-2">
                <div class="grid grid-cols-3 gap-2">
                  @for (option of monthOptions; track option.value) {
                    <button type="button"
                      (click)="exportOptions.selectedMonths = option.value"
                      [class.bg-blue-600]="exportOptions.selectedMonths === option.value"
                      [class.text-white]="exportOptions.selectedMonths === option.value"
                      [class.bg-gray-100]="exportOptions.selectedMonths !== option.value"
                      [class.text-gray-700]="exportOptions.selectedMonths !== option.value"
                      class="px-3 py-2 text-sm rounded-md border transition-colors hover:bg-blue-50">
                      {{ option.label }}
                    </button>
                  }
                </div>
                <p class="text-xs text-gray-500 mt-2">
                  {{ getIncidentsByMonths(exportOptions.selectedMonths || 3).length }} incident(s) dans les {{
                  exportOptions.selectedMonths || 3 }} dernier(s) mois
                </p>
              </div>
            }

            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-md transition-colors">
              <input type="radio" [(ngModel)]="exportOptions.period" value="custom-range" name="exportPeriod"
                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-900">
                <strong>PÃ©riode personnalisÃ©e</strong>
              </span>
            </label>

            <!-- SÃ©lecteur de pÃ©riode personnalisÃ©e -->
            @if (exportOptions.period === 'custom-range') {
              <div class="ml-7 mt-2 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs text-gray-600 mb-1">Date de dÃ©but</label>
                    <input type="date" [(ngModel)]="exportOptions.customStartDate"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600 mb-1">Date de fin</label>
                    <input type="date" [(ngModel)]="exportOptions.customEndDate"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                  </div>
                </div>
                @if (exportOptions.customStartDate && exportOptions.customEndDate) {
                  <p class="text-xs text-gray-500">
                    {{ getIncidentsByDateRange(exportOptions.customStartDate, exportOptions.customEndDate).length }}
                    incident(s) dans cette pÃ©riode
                  </p>
                }
              </div>
            }
          </div>
        </div>

        <!-- RÃ©sumÃ© de l'export -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <h4 class="text-sm font-medium text-gray-800 mb-2">RÃ©sumÃ© de l'export</h4>
          <div class="text-sm text-gray-600 space-y-1">
            <div class="flex justify-between">
              <span>Format :</span>
              <span class="font-medium">{{ exportOptions.type.toUpperCase() }}</span>
            </div>
            <div class="flex justify-between">
              <span>Nombre d'incidents :</span>
              <span class="font-medium text-blue-600">{{ getExportCount() }}</span>
            </div>
            <div class="flex justify-between">
              <span>PÃ©riode :</span>
              <span class="font-medium">{{ getExportPeriodLabel() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer du modal -->
      <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
        <div class="flex items-center justify-between">
          <button (click)="closeModal()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
            Annuler
          </button>
          <button (click)="executeExport()" [disabled]="getExportCount() === 0"
            class="px-6 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            {{ exportOptions.type === 'xlsx' ? 'ðŸ“Š Exporter Excel' : 'ðŸ“„ Exporter PDF' }} ({{ getExportCount() }})
          </button>
        </div>
      </div>
    </div>
  </div>
}